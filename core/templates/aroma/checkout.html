<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - ReStyle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-50">
    <!--NavBar-->
    {% include 'aroma/navbar.html' %}

    <!-- Checkout Content -->
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Checkout Form -->
        <div class="lg:col-span-2 space-y-6">
          <!-- Shipping Information -->
          <div class="bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">
              Shipping Information
            </h2>
            <form class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >First Name</label
                  >
                  <input
                    type="text"
                    id="first-name"
                    class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Last Name</label
                  >
                  <input
                    type="text"
                    id="last-name"
                    class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                  />
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Email Address</label
                >
                <input
                  type="email"
                  id="email"
                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Phone Number</label
                >
                <input
                  type="text"
                  id="phone"
                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                />
              </div>
              <div id="address-list" class="space-y-2"></div>
            </form>
          </div>

          <!-- Shipping Method -->
          <div class="bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">
              Shipping Method
            </h2>
            <div class="space-y-3">
              <label
                class="flex items-center p-3 border border-gray-200 rounded-md cursor-pointer hover:bg-gray-50"
              >
                <input
                  type="radio"
                  name="shipping"
                  class="text-green-600 focus:ring-green-500"
                  checked
                />
                <div class="ml-3 flex-1">
                  <div class="flex justify-between">
                    <span class="font-medium text-gray-900"
                      >Standard Shipping</span
                    >
                    <span class="text-gray-900">Free</span>
                  </div>
                  <p class="text-sm text-gray-500">5-7 business days</p>
                </div>
              </label>

              <label
                class="flex items-center p-3 border border-gray-200 rounded-md cursor-pointer hover:bg-gray-50"
              >
                <input
                  type="radio"
                  name="shipping"
                  class="text-green-600 focus:ring-green-500"
                />
                <div class="ml-3 flex-1">
                  <div class="flex justify-between">
                    <span class="font-medium text-gray-900"
                      >Express Shipping</span
                    >
                    <span class="text-gray-900">$9.99</span>
                  </div>
                  <p class="text-sm text-gray-500">2-3 business days</p>
                </div>
              </label>

              <label
                class="flex items-center p-3 border border-gray-200 rounded-md cursor-pointer hover:bg-gray-50"
              >
                <input
                  type="radio"
                  name="shipping"
                  class="text-green-600 focus:ring-green-500"
                />
                <div class="ml-3 flex-1">
                  <div class="flex justify-between">
                    <span class="font-medium text-gray-900"
                      >Overnight Shipping</span
                    >
                    <span class="text-gray-900">$19.99</span>
                  </div>
                  <p class="text-sm text-gray-500">Next business day</p>
                </div>
              </label>
            </div>
          </div>
        </div>

        <!-- Order Summary -->
        <div class="lg:col-span-1">
          <div class="bg-white rounded-lg shadow-sm p-6 sticky top-24">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">
              Order Summary
            </h2>

            <!-- Order Items -->
            <div id="items" class="space-y-4 mb-6"></div>

            <!-- Order Totals -->
            <div class="border-t pt-4 space-y-2">
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Total Items</span>
                <span id="totalQuantity" class="text-gray-900"></span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Shipping</span>
                <span class="text-gray-900">Free</span>
              </div>
              <div
                class="border-t pt-2 flex justify-between font-semibold text-lg"
              >
                <span class="text-gray-900">Total</span>
                <span id="totalPrice" class="text-gray-900">0.00$</span>
              </div>
            </div>

            <!--Uplaod Qr-->
            <div class="">
              <select
                id="qrSelect"
                class="w-full border border-gray-200 py-2 rounded-md my-3"
              >
                <option>Select QR</option>
                <option
                  type="file"
                  data-img="/media/images/qrcodes/photo_1_2025-06-17_15-10-35.jpg"
                  value="/media/images/qrcodes/photo_1_2025-06-17_15-10-35.jpg"
                >
                  ACLEDA<img
                    src="/media/images/qrcodes/photo_1_2025-06-17_15-10-35.jpg"
                    alt="ABA"
                  />
                </option>
                <option
                  type="file"
                  data-img="/media/images/qrcodes/photo_2_2025-06-17_15-10-35.jpg"
                  value="/media/images/qrcodes/photo_2_2025-06-17_15-10-35.jpg"
                >
                  ABA<img
                    src="/media/images/qrcodes/photo_2_2025-06-17_15-10-35.jpg"
                    alt="ABA"
                  />
                </option>
              </select>
              <div id="qrImageContainer"></div>
              <div class="mb-3 space-y-3">
                <label for="qrUpload" class="text-gray-500"
                  >Upload Payment Reciet here:</label
                >
                <input type="file" id="qrUpload" accept="image/*" class="" />
              </div>
              <div id="payImageContainer"></div>
            </div>
            <!-- Place Order Button -->
            <a
              id="createOrderBtn"
              class="w-full bg-green-600 text-white py-3 rounded-md font-semibold hover:bg-green-700 mt-6 block text-center"
            >
              Proceed to Pay
            </a>
          </div>
        </div>
      </div>
    </div>
    <!--Footer-->
    {% include 'aroma/footer.html' %}

    <script>
      function fetchCustomerInfo(user) {
        const firstName = document.getElementById("first-name");
        const lastName = document.getElementById("last-name");
        const emailAddress = document.getElementById("email");
        const phone_number = document.getElementById("phone");

        const firstname =
          user.user?.first_name || localStorage.getItem("first_name");
        const lastname =
          user.user?.last_name || localStorage.getItem("last_name");
        const email = user.user?.email || localStorage.getItem("email");
        const phoneNumber = user.user?.phone || localStorage.getItem("phone");

        if (firstName) firstName.value = firstname;
        if (lastName) lastName.value = lastname;
        if (emailAddress) emailAddress.value = email;
        if (phone_number) phone_number.value = phoneNumber;
      }
      async function fetchCustomerAddresse() {
        try {
          const addresses = await fetchWithAuth("/api/customer-addresses/");
          console.log("Fetched addresses:", addresses);

          cachedAddresses = addresses; // Cache for later use

          const list = document.getElementById("address-list");
          list.innerHTML = "";

          if (addresses.length === 0) {
            list.innerHTML = "<p class='text-gray-500'>No addresses found.</p>";
            return;
          }

          const address = addresses[0];
          localStorage.setItem("addressId", JSON.stringify(address.id));

          const div = document.createElement("div");
          div.innerHTML = `
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                <input
                type="text"
                id="street"
                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                value="${address.street || ""}"
                />
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">City</label>
                <input
                    type="text"
                    id="city"
                    class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                    value="${address.city || ""}"
                />
                </div>
                <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Country</label>
                <input
                    type="text"
                    id="country"
                    class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                    value="${address.country || ""}"
                />
                </div>
                <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ZIP Code</label>
                <input
                    type="text"
                    id="zip"
                    class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                    value="${address.postal_code || ""}"
                />
                </div>
            </div>
            `;

          list.appendChild(div);
        } catch (err) {
          console.error("Error loading addresses:", err);
        }
      }

      function getItems() {
        const storedProducts =
          JSON.parse(localStorage.getItem("selectedProducts")) || [];
        console.log("Selected products:", storedProducts);

        const itemslist = document.getElementById("items");
        itemslist.innerHTML = "";

        storedProducts.forEach((product) => {
          const div = document.createElement("div");
          div.classList.add("mb-4");

          div.innerHTML = `
            <div class="flex gap-4">
                <div class="flex-1">
                <h3 class="font-medium text-gray-900">${
                  product.productName
                }</h3>
                <p class="text-sm text-gray-500">Size: M</p>
                <p class="text-sm text-gray-500 mb-3">Qty: ${
                  product.quantity || 1
                }</p>
                <hr/>
                <div class="flex items-center justify-between mt-3">
                    <span>Subtotal:</span>
                    <p class="font-semibold text-green-600">$${
                      product.subtotal
                    }</p>
                </div>
                </div>
            </div>
            `;
          itemslist.appendChild(div);
        });
      }
      function updateTotalSummary() {
        const selectedProducts =
          JSON.parse(localStorage.getItem("selectedProducts")) || [];
        const totalQuantity = selectedProducts.reduce(
          (sum, item) => sum + item.quantity,
          0
        );
        const totalSubtotal = selectedProducts.reduce(
          (sum, item) => sum + item.subtotal,
          0
        );

        // Update quantity in HTML
        document.getElementById(
          "totalQuantity"
        ).textContent = `${totalQuantity}`;
        // document.getElementById("totalSubtotal").textContent = `$${totalSubtotal}`;
        document.getElementById("totalPrice").textContent = `$${totalSubtotal}`;

        console.log(totalQuantity);
        console.log(totalSubtotal);
      }

      document
        .getElementById("qrSelect")
        .addEventListener("change", function () {
          const imgUrl =
            this.selectedOptions[0]?.getAttribute("data-img") || "";
          if (imgUrl) {
            document.getElementById(
              "qrImageContainer"
            ).innerHTML = `<img src="${imgUrl}" width="120" class="img-thumbnail" />`;
          } else {
            document.getElementById("qrImageContainer").innerHTML = "";
          }
        });
      document
        .getElementById("qrUpload")
        .addEventListener("change", function () {
          if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
              document.getElementById(
                "payImageContainer"
              ).innerHTML = `<img src="${e.target.result}" width="120" class="img-thumbnail" />`;
            };
            reader.readAsDataURL(this.files[0]);
          } else {
            document.getElementById("payImageContainer").innerHTML = "";
          }
        });

      if (createOrderBtn) {
        createOrderBtn.addEventListener("click", async () => {
          const token = localStorage.getItem("access_token");
          const shippingAddressId = localStorage.getItem("addressId");
          const selectedProducts =
            JSON.parse(localStorage.getItem("selectedProducts")) || [];
          console.log(selectedProducts);
          const qrSelect = document.getElementById("qrSelect");
          const paymentProofInput = document.getElementById("qrUpload");

          if (!token) {
            alert("Please log in to place your order.");
            return;
          }

          if (!shippingAddressId || selectedProducts.length === 0) {
            alert("Missing address or selected products.");
            return;
          }

          if (
            !paymentProofInput.files ||
            paymentProofInput.files.length === 0
          ) {
            alert("Please upload your payment receipt before proceeding.");
            paymentProofInput.focus();
            return;
          }

          const formData = new FormData();
          formData.append("shipping_address_id", shippingAddressId);
          formData.append("is_paid", true);

          if (qrSelect?.value) {
            formData.append("QRCodeInvoice", qrSelect.value);
          }

          if (paymentProofInput?.files.length > 0) {
            formData.append("payment_proof", paymentProofInput.files[0]);
            console.log(
              "Payment proof file added:",
              paymentProofInput.files[0]
            );
          }

          // ✅ Send items as JSON string
          const itemsData = selectedProducts.map((item) => ({
            product_id: item.productId,
            quantity: item.quantity,
            store_price: item.unitPrice || 0,
            product_price: item.unitPrice || 0,
          }));
          console.log(itemsData);
          formData.append("items", JSON.stringify(itemsData)); // required by your serializer

          try {
            const res = await fetch("/api/customer-order/", {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`, // ✅ fix token format
                // Do NOT set Content-Type manually
              },
              body: formData,
            });

            const data = await res.json();
            if (res.ok) {
              console.log("Order created:", data);
              window.location.href = `/comfirmation/`;
            } else {
              console.error("Order failed:", data);
              alert("Failed to create order.");
            }
          } catch (err) {
            console.error("Error:", err);
            alert("Something went wrong while creating the order.");
          }
        });
      }

      updateTotalSummary();
      getItems();
      fetchCustomerAddresse();
    </script>
  </body>
</html>
