{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sign Up - ReStyle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="{% static 'js/auth.js' %}"></script>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- Register Section -->
    <div class="flex min-h-screen">
      <!-- Left Side - Registration Form -->
      <div class="w-full lg:w-1/2 flex items-center justify-center px-6 py-12">
        <div class="w-full max-w-md">
          <!-- Header -->
          <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">
              Create Account
            </h2>
            <p class="text-gray-600">
              Join ReStyle and start your sustainable fashion journey!
            </p>
          </div>

          <!-- Registration Form -->
          <form class="space-y-6" id="registerForm">
            <!-- Name Fields -->
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label
                  for="firstName"
                  class="block text-sm font-medium text-gray-700 mb-2"
                >
                  First Name
                </label>
                <input
                  type="text"
                  id="firstName"
                  name="firstName"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors"
                  placeholder="First name"
                />
                <div
                  class="text-red-500 text-sm mt-1 hidden"
                  id="firstNameError"
                >
                  First name is required
                </div>
              </div>
              <div>
                <label
                  for="lastName"
                  class="block text-sm font-medium text-gray-700 mb-2"
                >
                  Last Name
                </label>
                <input
                  type="text"
                  id="lastName"
                  name="lastName"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors"
                  placeholder="Last name"
                />
                <div
                  class="text-red-500 text-sm mt-1 hidden"
                  id="lastNameError"
                >
                  Last name is required
                </div>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <!-- Username Field -->
              <div>
                <label
                  for="username"
                  class="block text-sm font-medium text-gray-700 mb-2"
                >
                  Username
                </label>
                <div class="relative">
                  <input
                    type="text"
                    id="username"
                    name="username"
                    required
                    class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors"
                    placeholder="Username"
                  />
                  <div class="absolute inset-y-0 left-0 pl-4 flex items-center">
                    <i class="fa-solid fa-user text-gray-400"></i>
                  </div>
                </div>
              </div>
              <!-- Phone Field -->
              <div>
                <label
                  for="phone"
                  class="block text-sm font-medium text-gray-700 mb-2"
                >
                  Phone Number
                </label>
                <div class="relative">
                  <input
                    type="tel"
                    id="phone"
                    name="phone"
                    required
                    class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors"
                    placeholder="Phone number"
                  />
                  <div class="absolute inset-y-0 left-0 pl-4 flex items-center">
                    <i class="fas fa-phone text-gray-400"></i>
                  </div>
                </div>
              </div>
            </div>

            <!-- Phone Field -->
            <div>
              <label
                for="email"
                class="block text-sm font-medium text-gray-700 mb-2"
              >
                Email
              </label>
              <div class="relative">
                <input
                  type="email"
                  id="email"
                  name="email"
                  required
                  class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors"
                  placeholder="Enter your Email"
                />
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center">
                  <i class="fa-solid fa-envelope text-gray-400"></i>
                </div>
              </div>
            </div>

            <!-- Password Field -->
            <div>
              <label
                for="password"
                class="block text-sm font-medium text-gray-700 mb-2"
              >
                Password
              </label>
              <div class="relative">
                <input
                  type="password"
                  id="password"
                  name="password"
                  required
                  class="w-full px-4 py-3 pl-12 pr-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors"
                  placeholder="Create a password"
                />
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center">
                  <i class="fas fa-lock text-gray-400"></i>
                </div>
                <button
                  type="button"
                  class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-gray-600"
                  onclick="togglePassword('password')"
                >
                  <i class="fas fa-eye" id="passwordToggle"></i>
                </button>
              </div>
              <div class="text-red-500 text-sm mt-1 hidden" id="passwordError">
                Password must be at least 8 characters
              </div>

              <!-- Password Strength Indicator -->
              <div class="mt-2">
                <div class="flex space-x-1">
                  <div
                    class="h-1 flex-1 bg-gray-200 rounded"
                    id="strength1"
                  ></div>
                  <div
                    class="h-1 flex-1 bg-gray-200 rounded"
                    id="strength2"
                  ></div>
                  <div
                    class="h-1 flex-1 bg-gray-200 rounded"
                    id="strength3"
                  ></div>
                  <div
                    class="h-1 flex-1 bg-gray-200 rounded"
                    id="strength4"
                  ></div>
                </div>
                <p class="text-xs text-gray-500 mt-1" id="strengthText">
                  Password strength
                </p>
              </div>
            </div>

            <!-- Confirm Password Field -->
            <div>
              <label
                for="confirmPassword"
                class="block text-sm font-medium text-gray-700 mb-2"
              >
                Confirm Password
              </label>
              <div class="relative">
                <input
                  type="password"
                  id="confirmPassword"
                  name="confirmPassword"
                  required
                  class="w-full px-4 py-3 pl-12 pr-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors"
                  placeholder="Confirm your password"
                />
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center">
                  <i class="fas fa-lock text-gray-400"></i>
                </div>
                <button
                  type="button"
                  class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-gray-600"
                  onclick="togglePassword('confirmPassword')"
                >
                  <i class="fas fa-eye" id="confirmPasswordToggle"></i>
                </button>
              </div>
              <div
                class="text-red-500 text-sm mt-1 hidden"
                id="confirmPasswordError"
              >
                Passwords do not match
              </div>
            </div>

            <!-- Terms and Conditions -->
            <div class="flex items-start">
              <input
                type="checkbox"
                id="terms"
                name="terms"
                required
                class="mt-1 rounded border-gray-300 text-green-600 focus:ring-green-500"
              />
              <label for="terms" class="ml-3 text-sm text-gray-600">
                I agree to the
                <a
                  href="#"
                  class="text-green-600 hover:text-green-700 font-medium"
                  >Terms of Service</a
                >
                and
                <a
                  href="#"
                  class="text-green-600 hover:text-green-700 font-medium"
                  >Privacy Policy</a
                >
              </label>
            </div>
            <div class="text-red-500 text-sm hidden" id="termsError">
              You must agree to the terms and conditions
            </div>

            <!-- Newsletter Subscription -->
            <div class="flex items-start">
              <input
                type="checkbox"
                id="newsletter"
                name="newsletter"
                class="mt-1 rounded border-gray-300 text-green-600 focus:ring-green-500"
              />
              <label for="newsletter" class="ml-3 text-sm text-gray-600">
                Subscribe to our newsletter for sustainable fashion tips and
                exclusive offers
              </label>
            </div>

            <!-- Submit Button -->
            <button
              type="submit"
              class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors"
            >
              <span id="registerButtonText">Create Account</span>
              <i
                class="fas fa-spinner fa-spin ml-2 hidden"
                id="registerSpinner"
              ></i>
            </button>
          </form>

          <!-- Divider -->
          <div class="mt-8">
            <div class="relative">
              <div class="absolute inset-0 flex items-center">
                <div class="w-full border-t border-gray-300"></div>
              </div>
              <div class="relative flex justify-center text-sm">
                <span class="px-2 bg-gray-50 text-gray-500"
                  >Or sign up with</span
                >
              </div>
            </div>
          </div>

          <!-- Social Registration -->
          <div class="mt-6 grid grid-cols-2 gap-3">
            <button
              class="flex items-center justify-center px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors group"
            >
              <i
                class="fab fa-google text-red-500 mr-2 group-hover:scale-110 transition-transform"
              ></i>
              <span class="text-sm font-medium text-gray-700">Google</span>
            </button>
            <button
              class="flex items-center justify-center px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors group"
            >
              <i
                class="fab fa-facebook text-blue-600 mr-2 group-hover:scale-110 transition-transform"
              ></i>
              <span class="text-sm font-medium text-gray-700">Facebook</span>
            </button>
          </div>

          <!-- Sign In Link -->
          <div class="mt-8 text-center">
            <p class="text-sm text-gray-600">
              Already have an account?
              <a
                href="{% url 'login' %}"
                class="text-green-600 hover:text-green-700 font-medium"
              >
                Sign in here
              </a>
            </p>
          </div>
        </div>
      </div>

      <!-- Right Side - Image/Branding -->
      <div
        class="hidden lg:flex lg:w-1/2 bg-gradient-to-br from-green-600 via-green-700 to-green-800 relative overflow-hidden"
      >
        <div class="absolute inset-0 bg-black opacity-20"></div>
        <div
          class="absolute inset-0 flex items-center justify-center"
          id="register-image"
        >
          <img
            src=""
            alt="Sustainable Fashion Community"
            class="w-full h-full object-cover opacity-30"
          />
        </div>
        <div
          class="relative z-10 flex flex-col justify-center px-12 text-white"
        >
          <div class="max-w-md">
            <h1 class="text-4xl font-bold mb-6">Join the ReStyle Community</h1>
            <p class="text-xl text-green-100 mb-8">
              Be part of the sustainable fashion revolution. Buy, sell, and
              discover unique pre-loved pieces.
            </p>

            <div class="space-y-6">
              <div class="flex items-start">
                <div
                  class="w-12 h-12 bg-green-500 rounded-lg flex items-center justify-center mr-4 flex-shrink-0"
                >
                  <i class="fas fa-shopping-bag text-white"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-lg mb-2">Shop Sustainably</h3>
                  <p class="text-green-100 text-sm">
                    Discover unique, pre-loved fashion pieces at great prices
                  </p>
                </div>
              </div>

              <div class="flex items-start">
                <div
                  class="w-12 h-12 bg-green-500 rounded-lg flex items-center justify-center mr-4 flex-shrink-0"
                >
                  <i class="fas fa-plus-circle text-white"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-lg mb-2">Sell Your Items</h3>
                  <p class="text-green-100 text-sm">
                    Turn your closet into cash by selling items you no longer
                    wear
                  </p>
                </div>
              </div>

              <div class="flex items-start">
                <div
                  class="w-12 h-12 bg-green-500 rounded-lg flex items-center justify-center mr-4 flex-shrink-0"
                >
                  <i class="fas fa-heart text-white"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-lg mb-2">Make an Impact</h3>
                  <p class="text-green-100 text-sm">
                    Reduce fashion waste and support sustainable practices
                  </p>
                </div>
              </div>
            </div>

            <div
              class="mt-8 p-4 bg-green-500 bg-opacity-20 rounded-lg border border-green-400"
            >
              <p class="text-green-100 text-sm">
                <i class="fas fa-gift mr-2"></i>
                <strong>Welcome Bonus:</strong> Get $10 off your first purchase
                when you sign up!
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Password strength checker
      document
        .getElementById("password")
        .addEventListener("input", function (e) {
          const password = e.target.value;
          const strength = calculatePasswordStrength(password);
          updatePasswordStrength(strength);
        });

      function calculatePasswordStrength(password) {
        let strength = 0;
        if (password.length >= 8) strength++;
        if (/[a-z]/.test(password)) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^A-Za-z0-9]/.test(password)) strength++;
        return Math.min(strength, 4);
      }

      function updatePasswordStrength(strength) {
        const indicators = ["strength1", "strength2", "strength3", "strength4"];
        const colors = [
          "bg-red-500",
          "bg-orange-500",
          "bg-yellow-500",
          "bg-green-500",
        ];
        const texts = ["Very Weak", "Weak", "Fair", "Good", "Strong"];

        indicators.forEach((id, index) => {
          const element = document.getElementById(id);
          element.className =
            "h-1 flex-1 rounded " +
            (index < strength
              ? colors[Math.min(strength - 1, 3)]
              : "bg-gray-200");
        });

        document.getElementById("strengthText").textContent =
          strength > 0 ? texts[strength - 1] : "Password strength";
      }

      // Form validation

      const REGISTER_API = "/api/register/";
      const isRegistered = false;

      document
        .getElementById("registerForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const firstName = document.getElementById("firstName").value.trim();
          const lastName = document.getElementById("lastName").value.trim();
          const username = document.getElementById("username").value.trim();
          const phone = document.getElementById("phone").value.trim();
          const password = document.getElementById("password").value;
          const confirmPassword =
            document.getElementById("confirmPassword").value;
          const email = document.getElementById("email")?.value.trim(); // optional email

          if (password !== confirmPassword) {
            alert("Passwords do not match.");
            return;
          }

          const formData = {
            first_name: firstName,
            last_name: lastName,
            username: username,
            phone: phone,
            password: password,
            email: email, // make sure to send this even if blank
          };

          const registerButton = document.getElementById("registerButtonText");
          const registerSpinner = document.getElementById("registerSpinner");

          registerButton.textContent = "Creating Account...";
          registerSpinner.classList.remove("hidden");

          try {
            const response = await fetch(REGISTER_API, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(formData),
            });

            if (response.ok) {
              const data = await response.json();
              // Store tokens
              localStorage.setItem("access_token", data.access);
              localStorage.setItem("refresh_token", data.refresh);

              // Store user info
              localStorage.setItem(
                "user",
                JSON.stringify({
                  id: data.user_id,
                  username: data.username,
                  email: data.email,
                  first_name: data.first_name,
                  last_name: data.last_name,
                  phone: data.phone,
                  profile_image: data.profile_image,
                })
              );

              handleRegisterLoginResponse(data);

              alert("Account created successfully!");

              isRegistered = true;
            } else {
              const errorData = await response.json();
              console.error("Registration failed:", errorData);

              // Improved alert message formatting
              const errorMessages = Object.entries(errorData)
                .map(([field, messages]) => `${field}: ${messages.join(", ")}`)
                .join("\n");

              alert("Registration failed:\n" + errorMessages);
              return false;
            }
          } catch (error) {
            console.error("Network or server error:", error);
            // alert("Error connecting to server.");
          } finally {
            registerButton.textContent = "Create Account";
            registerSpinner.classList.add("hidden");
          }
        });

      // Password toggle
      function togglePassword(fieldId) {
        const field = document.getElementById(fieldId);
        const toggle = document.getElementById(fieldId + "Toggle");

        if (field.type === "password") {
          field.type = "text";
          toggle.classList.remove("fa-eye");
          toggle.classList.add("fa-eye-slash");
        } else {
          field.type = "password";
          toggle.classList.remove("fa-eye-slash");
          toggle.classList.add("fa-eye");
        }
      }

      function getRegisterImage() {
        const IMAGE_API = "/api/images/";
        const ImageTypeId = 3;

        fetch(IMAGE_API)
          .then((res) => res.json())
          .then((images) => {
            const divImageSection = document.getElementById("register-image");
            const filteredImages = images.filter(
              (img) => img.imageTypeID === ImageTypeId
            );

            if (filteredImages.length > 0) {
              const img = filteredImages[0]; // Use the first matching image
              divImageSection.innerHTML = `
                        <img src="${img.imageURL}" alt="Sustainable Fashion" class="w-full h-full object-cover opacity-30">
                    `;
            }
          })
          .catch((err) => {
            console.error("Image load error:", err);
          });
      }

      getRegisterImage();

      async function createCart() {
        if (isRegistered) {
          const token = localStorage.getItem("access_token");

          try {
            const res = await fetch("/api/carts/", {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            });

            const data = await res.json();

            if (res.ok) {
              console.log("🛒 Cart created:", data);
              localStorage.setItem("cart_id", data.id);
              return true;
            } else {
              console.error("❌ Failed to create cart:", data.error || data);
              return false;
            }
          } catch (err) {
            console.error("Error creating cart:", err);
            return false;
          }
        } else {
          console.warn("User not logged in. Cart not created.");
          return false;
        }
      }
    </script>
  </body>
</html>
